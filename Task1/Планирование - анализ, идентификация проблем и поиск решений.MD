## Планирование: анализ, идентификация проблем и поиск решений

### Анализ текущего решения

Текущая реализация решает часть задач бизнеса:

#### Взаимодействие с покупателем

Внешний пользователь приходит в интернет магазин(Internet Shop) работает с api(Spring Boot),
подготавливает свою 3D-модель или выбирает из предложенных, формирует заказ. Данные о модели сохраняются в
s3 информация о заказе в бд.

#### Взаимодействие с продавцом

Продавец это сотрудник компании, который взаимодействует с фронтендом CRM в зависимости от своей роли 
и ответственности обрабатывает заказы. Заказы получает CRM API(Spring Boot), которая взаимодействует c s3 
для получения 3-d модели, как с базой данных, для получения информации по заказу, так и с брокером сообщений,
для получения изменения статусов на каждом этапе заказа.

#### Взаимодействие c сторонними компаниями (предоставление api) для производства им изделий

Пользователь api, может отправить параметры заказа для расчета стоимости изделия, чтобы его подтвердить и затем
отправить на производство расчет происходит в MES API(C#), аналогично взаимодействие происходит и s3, брокером, 
и свой базой данных производства.

#### Оператор производства

Внутренний сотрудник компании линии производства, взаимодействует с MES фронтендом, 
для обработки заказов на линию производства взаимодействует с MES API.

#### Текущие параметры и условия работы системы:

1. Линейный рост каждый месяц +100 заказов от месяца к месяцу.
2. Расчет 3d модели от 2 до 30 минут.
3. В производственных мощностях, пока нет проблем, тек мощности справятся с 2ух кратным ростом.
4. Компания работает в cloud.

### Проблемы компании

1. Жалобы клиентов на просрочку выдачи заказов ожидание(3 недели), реальность заказ не готов через несколько месяцев.
2. Жалобы со стороны пользователей API не получили заказы.
3. Жалобы операторов производства на долгую загрузку системы. Операторам важно видеть новые заказы.
4. Долгие релизы.
5. Растущая нагрузка.

### Инициативы для устранения нежелательных операций.

1. Добавить api gateway, чтобы общая точка входа была через него, здесь же добавил бы авторизацию и присвоение ролей,
 чтобы снять нагрузку с сервисов бэкэнда. Так же чтобы в дальнейшем была возможность балансировки, 
 и сохранения состояний для пользователей в рамках приложения при горизонтальном масштабировании.
2. Мониторинг, для выявления причин пропавших заказов. Чтобы понять в чем проблема, 
 необходим трейсинг всех сервисов от фронтенда, до конечного сервиса, так же необходимы логи сервисов, 
 и желательно их централизованное хранение.
 Поскольку есть проблема с производительностью баз данных(проблема у операторов), то необходимо мониторить и их.
 Не лишним будет, мониторить и пропускную способность Rabbit-MQ.
3. Кэширование, закешировал бы стандартные каталоги, которые предлагает компания, для поднятия производительности работы,
 интернет магазина.
4. Горизонтальное масштабирование, кажется узким местом выглядит работа с MES системой, 
 попробовал бы вертикально/горизонтально масштабировать процесс расчета 3d-Модели, при очень плохом сценарии 
 мы будем рассчитывать модель очень долго, возможно подумал бы о кэшировании и расчете на основании данных кэша 
 если такое возможно.
5. Добавил бы реплики на базы данных, возможно бы разделил чтение и запись, 
 подумал бы над возможностью реализации шардирования. Так же можно проработать вариант и с вертикальным масштабированием.
6. Подумал бы над разделением баз CRM и интернет магазина, для исключения зависимости друг от друга.
7. Поскольку есть проблема с потерей заказов, подумал бы об однозначной доставки сообщений помимо мониторинга,
 реализацию exactly-once паттерна в rabbit mq, или же вообще rabbit mq замены на kafka, где такой паттерн в целом реализуем 
 работа по pull возможно в данном случае даже будет лучше в особенности при изменении нагрузки. 
 В том числе увеличение партиций
8. Добавил бы реализацию backpressue для MES. Кажется это самый неравномерно нагруженный сервис для обработки. 
 Если на него действительно высокая нагрузка по результатам мониторинга, то в дальнейшем точно каким-то образом 
 масштабировать его, горизонтально или вертикально или оба варианта.
9. Добавил бы dba для оптимизации работ с базами данных + в случае репликаций, 
 поддержки инфраструктуры и отслеживанием инцидентов синхронизаций. 
 Так же бы на проработку проблемных мест производительности.
10. Добавил бы регресс интеграционные тесты в автоматизированном виде, с девопсами обсудил бы возможность их реализации 
 в ci-cd, + возможность в найм авто-тестировщика.
11. Реализовал бы возможность канареечных релизов, в том числе для этого бы поспособствовало добавление api gateway. 
 Это помогло бы ускорить доставку фитч в прод.
12. Подумал бы об автоматизации релизов в release и prod. В том числе простых откатов при критичных ошибках.
13. Если рост организации останется приличный, подумал бы о расширении производства, 
 поскольку производственных мощностей в скором времени может не хватить, если это дорого, 
 то подумал бы о привлечении внешних производителей и создания api для работы с ними. Т.е. у нас заказывают, 
 а производство отдаём на аутсорс, если не справляемся.
14. Попробовал бы сделать актуальный дашбород текущих заказов, чтобы не приходилось читать полные блоки из бд,
 возможно задумался над партицированием по дням, поэтому что как было подчеркнуто самые важные это текущие заказы, 
 которые необходимо обработать я так полагаю, именно момент отправки на производство, остальные, 
 возможно получать даже как то асинхронно. Возможно применить кэширование, 
 для работы с дашбордом по не оперативным заказам.

### Порядок реализации инициатив

Если бы приходилось выбирать в какой последовательности применять инициативы, я бы предположил, что самые важные 
проблемы это потеря заказов. И долгие загрузки заказов на производстве.

1. 2 - Поэтому я бы предложил сделать сразу несколько вещей например devops отправил бы разворачивать мониторинг, а 
разработчикам добавить необходимые компоненты для сбора метрик трейсов и логов. Т.е. первый пункт 2, 
это бы позволило формировать предупреждающий фронт проблем и получить подтверждения теорий потери заказов 
и долгой загрузки.
2. 14 - Далее предложил бы над реализацией оптимизаций запросов 14, чтобы починить дашборд. Возможно заказы теряются именно на этом моменте,
потому что оператор их пропускает.
3. 8 или 4 - Следующим шагом попробовал бы решить проблему не быстрого формирования 3-d моделей,
 да и в целом MES система выглядит сильно нагруженной 4. 
 Если сразу нельзя поднять инстанс и направить трафик, подумал бы над реализациями в пункте 8.
4. 7 - Спорный пункт возможно его можно было бы поднять выше, но из-за нехватки информации пусть будет так.
Исследовал бы доставку rabbit-mq и реализацию паттерна exactly - once.
5. 5 - Усилил бы хранение данных, а именно добавил бы реплицирование возможно разгрузил бы БД при проблеме именно в них.
 Если бы мы однозначно знали сразу, что проблема есть с БД, тогда этот пункт был бы самым первым, 
 потому что вертикальное и горизонтальное масштабирование в кладуе простое, по крайней мере без шардирования, 
 т.е. почти без затрат времени на разработку.
6. 3 - подумал бы над кэшированием особенно при росте числа пользователей.

Далее, бы охарактеризовал менее критичные пункты:

7. 10 - ускоряем, выпуск релизов.
8. 12 - чтобы начать ускорять, работу выпуска релизов.
9. 9 - найм dba, не то чтобы прям в этом пункте, это можно сделать сразу же еще до п1., 
 потому что поиск соискателя долгий, и не влияет на процессы.
10. 1 - реализовал бы api gateway, кажется он нужен и предыдущим пунктам.
11. 11 - еще ускоряем релизы так же у нас уже есть api-gateway.
12. 6 - подумал бы о разделении баз. такие решения нужно принимать только исследовав архитектуру.
13. 13 - если у нас все хорошо, и проблема уже не в нас, то пилим новые фитчи =)

PS план примерный, действовал бы по ситуации в зависимости от скоупа проблем, но очень грубый план выглядел бы +/- так.
Основной посыл такой, из-за чего теряем деньги и клиентов в первую очередь, что можно сделать параллельно, делаем:
(найм сотрудников, задачи на devops, разработку и тестирование), далее фитчи. Еще бы можно было делить, 
что делается очень быстро(и даёт большой профит), делаем сразу вне очереди(например поднять мощности в клауде), 
остальное в порядке приоритетов. Еще можно было бы запараллелить вопросы в поддержку в клауд при необходимости.
Так же, я понимаю, что в кладуе уже есть метрики, а у приложений логи. Я исключил факт, что с ними еще не ознакомились. 
Предполагаем что нам это ничего не дало.
Возможно бы имело смысл нанять SRE инженера.

Планируемая архитектура через пол года скорее, что-то частично реализованное из пунктов. Вообще идея в том,
чтобы выносить какую то логику в отдельны микросервисы, для дальнейшего масштабирования и повышения отказоустойчивости.
Хороший вариант обложить все метриками и обеспечить высокую отказоустойчивость системы. Наверное стоило бы 
сосредоточится на этом, а это значит у нас будет несколько контейнеров отвечающих за мониторинг, тейсинг и логи.