### Мотивация

Основная цель мониторинга, найти проблемы, с которыми сталкивается бизнес в текущей ситуации и 
предупреждать проблемы, до их появления чтобы бизнес с ними не сталкивался.
Все предупредить не возможно поэтому, мы сфокусируется в первую очередь на текущих проблемах:
1. Потеря заказов
2. Потеря контрактов
3. Долгое взаимодействие с интерфейсами
4. Поиск узких мест(по схеме C4, без глубокой детализации), т.е. понять в каком контейнере проблема.

Мониторинг даст компании возможность быстро находить проблемы и исправлять их, 
а лучше действовать на предупреждение проблем до их наступления.
В сравнении без мониторинга, просто можно потерять всех клиентов и разгорится, пока разработчики будут искать проблему,
наугад.

### Выбор подхода к мониторингу

1. RED для мониторинга api и rabbit. Синхронные и асинхронные вызовы.
в нашем случае:
- Shop API
- CRM API
- MES API
- RabbitMQ
Метрики
Rate - Количество запросов за промежуток времени для api, количество сообщений Rabbit

Errors - Количество 5хх для api, failed jobs для Rabbit.

Duration - Время ответа от API, задержка доставки сообщения.
2. USE для инфраструктуры:
- Сервера, CPU, RAM
- S3
- Postgres
- RabbitMQ

Utilization - Загрузка CPU, RAM, диск, сеть, количество соединение для бд.

Saturation - Очередь на диск, очередь запросов, активные блокировки.

Errors - Ошибки соединения, таймауты, deadlock - для бд.

3. 4 Golden Signals для пользовательского опыта:
- Интерфейсам CRM, MES, Internet Shop
- Партнёрским API

Latency - загрузка страницы, время отклика api

Traffic - количество пользователей, запросов api

Errors - ошибки фронтенда, и все 5хх, так же возможно ошибки авторизации и роутинга.

Saturation - перегрузка клиента, отказ при пиковых нагрузках.

### Выбор метрик
Список метрик в порядке их предоставления:

Number of dead-letter-exchange letters in RabbitMQ
- Зачем: показывает, сколько сообщений не было обработано корректно (отклонено, просрочено и т.п.). 
 Рост может означать сбои в CRM API или MES API.
- Ярлыки: queue_name, reason (например: expired, rejected)

Number of messages in flight in RabbitMQ
- Зачем: отражает количество сообщений, находящихся в обработке. Рост указывает на перегрузку или зависание обработчиков.
- Ярлыки: queue_name

Number of requests (RPS) for internet shop API, CRM API, MES API
- Зачем: помогает выявить пиковую нагрузку и понять, когда система начинает деградировать.
- Ярлыки: method, endpoint, status_code

Number of requests (RPS) per user for MES API
- Зачем: полезно для защиты от злоупотребления со стороны отдельных API-партнёров.
- Ярлыки: user_id, endpoint, status_code

Response time (latency) for shop API, CRM API, MES API
- Зачем: позволяет понять, где система тормозит. Особенно важно для MES, где жалуются операторы.
- Ярлыки: endpoint, method

CPU % for shop API, CRM API, MES API
- Зачем: определяет, какие сервисы перегружают процессор, может быть предвестником сбоев.
- Ярлыки: instance_id, container_id

Memory Utilisation for shop API, CRM API, MES API
- Зачем: выявляет утечки памяти или недоиспользование ресурсов.
- Ярлыки: instance_id, container_id

Memory Utilisation for shop db instance, MES db instance
- Зачем: указывает на нехватку памяти, что может влиять на кеши и скорость ответа БД.
- Ярлыки: db_instance

Number of connections for shop db instance, MES db instance
- Зачем: важно для понимания, не превышены ли лимиты подключения к БД, что может повлиять на отказ в новых запросах.
- Ярлыки: user, app

Number of HTTP 500 for shop API, CRM API, MES API
- Зачем: отражает внутренние ошибки сервисов, при превышении порога можно выдавать алерт.
- Ярлыки: endpoint, method, exception_type

Number of HTTP 200 for shop API, CRM API, MES API
- Зачем: подтверждает успешные запросы, отслеживать отношение неуспешных запросов к успешным.
- Ярлыки: endpoint, method

Number of simultaneous sessions for shop, CRM, MES API
- Зачем: помогает понять, сколько пользователей активно используют систему. Полезно для масштабирования.
- Ярлыки: region, client_type

Size of S3 storage, shop db instance, MES db instance
- Зачем: помогает следить за тем чтобы размер диска не переполнился, 
 и своевременного его расширения или удаления не нужных данных.
- Ярлыки: instance, bucket

Kb transferred (received / sent) for shop, CRM, MES API
- Зачем: позволяет выявить аномалии в трафике, особенно для 3D-файлов и API.
- Ярлыки: endpoint, direction (received/sent)

Дополнительно:
Time to first byte для фронтендов (MES, CRM)
- Зачем: важно для UX операторов и продавцов, особенно когда жалуются на долгую загрузку страницы.

Queue backlog time in RabbitMQ (время жизни сообщений в очереди)
- Зачем: если сообщения слишком долго лежат в очереди, это сигнал о медленной обработке.
- Ярлыки: queue_name

### План действий
1. Развернуть экземпляр Prometheus.
2. Настроить сбор метрик в контейнерах приложений/инстансов/очередей, в том числе с помощью prometheus экспортеров.
3. Настроить prometheus.yml для Prometheus для сбора метрик, указать откуда собирать и как часто.
4. Поднять экземпляр grafana
5. Подключить в grafana, как источник Prometheus.
6. Сформировать дашборды и виджеты, сгруппировать их по назначению.
7. Создать роли и права и назначить их пользователям для работы с метриками.
8. Настроить алерты, на важные параметры, это могут быть оповещения в мессенджер или на почту.
9. Для системных алертов например для USE можно использовать к Prometheus + Alertmanager, 
 например доступность бд или утилизация памяти redis.
10. При необходимости, добавлять новые метрики и алерты.

В случае яндекс облака можно попробовать настроить метрики в яндекс мониторинге. 
И использовать prometheus экспортер api для кастомных метрик, например приложений,
т.к. в случае облака большинство метрик USE уже готово.
